local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Player = game.Players.LocalPlayer

local Enabled = false

-- UI Setup
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 180, 0, 160)
MainFrame.Position = UDim2.new(0.5, -90, 0.5, -80)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.Active = true

local Input = Instance.new("TextBox", MainFrame)
Input.Size = UDim2.new(0.9, 0, 0, 25)
Input.Position = UDim2.new(0.05, 0, 0.08, 0)
Input.PlaceholderText = "Tên đối thủ..."

local Toggle = Instance.new("TextButton", MainFrame)
Toggle.Size = UDim2.new(0.9, 0, 0, 30)
Toggle.Position = UDim2.new(0.05, 0, 0.3, 0)
Toggle.Text = "OFF"
Toggle.BackgroundColor3 = Color3.fromRGB(150, 0, 0)

local DistInput = Instance.new("TextBox", MainFrame)
DistInput.Size = UDim2.new(0.42, 0, 0, 25)
DistInput.Position = UDim2.new(0.05, 0, 0.55, 0)
DistInput.Text = "5"

local AngleInput = Instance.new("TextBox", MainFrame)
AngleInput.Size = UDim2.new(0.42, 0, 0, 25)
AngleInput.Position = UDim2.new(0.53, 0, 0.55, 0)
AngleInput.Text = "90" 

local InfoLabel = Instance.new("TextLabel", MainFrame)
InfoLabel.Size = UDim2.new(1, 0, 0, 20)
InfoLabel.Position = UDim2.new(0, 0, 0.8, 0)
InfoLabel.BackgroundTransparency = 1
InfoLabel.Text = "Khoảng cách | Góc độ"
InfoLabel.TextColor3 = Color3.new(0.8, 0.8, 0.8)
InfoLabel.TextSize = 10

-- Drag logic
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)
UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UIS.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end end)

local function ResetCharacter()
    local char = Player.Character
    if char then
        for _, v in pairs(char:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = true end
        end
        local hum = char:FindFirstChild("Humanoid")
        if hum then hum.AutoRotate = true hum.PlatformStand = false end
    end
end

Toggle.MouseButton1Click:Connect(function()
    Enabled = not Enabled
    Toggle.Text = Enabled and "ON" or "OFF"
    Toggle.BackgroundColor3 = Enabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    if not Enabled then ResetCharacter() end
end)

local function GetTarget(str)
    if str == "" then return nil end
    for _, v in pairs(game.Players:GetPlayers()) do
        if v ~= Player and (v.Name:lower():find(str:lower()) or v.DisplayName:lower():find(str:lower())) then
            return v
        end
    end
    return nil
end

-- Main Loop
RunService.RenderStepped:Connect(function()
    local char = Player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    Player.DevCameraOcclusionMode = Enum.DevCameraOcclusionMode.Invisicam

    if Enabled and hrp then
        local target = GetTarget(Input.Text)
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = target.Character.HumanoidRootPart
            local dist = tonumber(DistInput.Text) or 5
            local angleVal = tonumber(AngleInput.Text) or 90
            
            -- Noclip & PlatformStand ép cứng
            for _, v in pairs(char:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
            local hum = char:FindFirstChild("Humanoid")
            if hum then hum.AutoRotate = false hum.PlatformStand = true end

            hrp.Velocity = Vector3.zero
            hrp.RotVelocity = Vector3.zero
            
            -- ÉP GÓC THEO ĐÚNG Ý BẠN:
            -- Ta giữ nguyên hướng xoay ngang của Target nhưng ép trục X theo AngleInput
            local targetPos = targetHRP.Position
            local posUnder = targetPos - Vector3.new(0, dist, 0)
            
            -- Tạo CFrame dựa trên hướng của đối thủ, sau đó xoay trục X đúng số độ nhập vào
            local newCF = CFrame.new(posUnder) * CFrame.Angles(0, math.rad(targetHRP.Orientation.Y), 0)
            hrp.CFrame = newCF * CFrame.Angles(math.rad(angleVal), 0, 0)
        else
            ResetCharacter()
        end
    end
end)
